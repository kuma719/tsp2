<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSP QRã‚¢ãƒ«ãƒãƒ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ§©</text></svg>">
  <style>
    .fade-in { animation: fade 0.3s ease-in; }
    @keyframes fade { from {opacity:0} to {opacity:1} }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
      <h1 class="text-2xl font-bold">TSP QRã‚¢ãƒ«ãƒãƒ  <span class="text-sm font-medium text-slate-500">ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ / ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</span></h1>
      <div class="flex items-center gap-2">
        <span id="statusDot" class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
        <span id="statusText" class="text-sm text-slate-600">ä¿å­˜æ¸ˆã¿</span>
      </div>
    </header>

    <section class="mb-4">
      <div class="rounded-2xl bg-white shadow p-4 sm:p-6">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="px-2 py-1 rounded-full text-xs bg-sky-100 text-sky-700">QR: çµ±ä¸€URL</span>
          <span id="browserTag" class="px-2 py-1 rounded-full text-xs bg-slate-100 text-slate-600"></span>
          <span id="pwaTag" class="hidden px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">PWA</span>
        </div>
        <p class="text-sm text-slate-600">ã“ã®ã‚¢ãƒ«ãƒãƒ ã¯<strong>ã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶</strong>ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã—ã¾ã›ã‚“ã€‚æ©Ÿç¨®å¤‰æ›´æ™‚ã¯ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ›¸ãå‡ºã—ã€â†’æ–°ç«¯æœ«ã§ã€Œèª­ã¿è¾¼ã¿ã€ã§ç§»è¡Œã§ãã¾ã™ã€‚</p>
      </div>
    </section>

    <section class="grid gap-4">
      <div class="rounded-2xl bg-white shadow p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">ã‚¿ã‚¤ãƒˆãƒ« / ãƒ¡ãƒ¢</h2>
        <input id="title" type="text" placeholder="ã‚¢ãƒ«ãƒãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«" class="w-full mb-3 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-400" />
        <textarea id="notes" rows="5" placeholder="æ—…ã®ãƒ¡ãƒ¢ã€æ°—ã¥ãã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³â€¦" class="w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-400"></textarea>
      </div>

      <div class="rounded-2xl bg-white shadow p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">å†™çœŸ / å‹•ç”»</h2>
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input id="compressToggle" type="checkbox" class="rounded border-slate-300"> <span class="text-sm text-slate-600">ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’è»½é‡åŒ–ï¼ˆæ¨å¥¨ï¼‰</span>
          </label>
        </div>
        <div class="flex flex-col sm:flex-row items-start gap-3 sm:items-center mb-3">
          <input id="fileInput" type="file" accept="image/*,video/*" multiple class="block text-sm" />
          <div class="text-xs text-slate-500">å¯¾å¿œï¼šç”»åƒ/å‹•ç”»ï¼ˆã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã€è‡ªå‹•ã§åœ§ç¸®ãƒ»ç¸®å°ã—ã¾ã™ï¼‰</div>
        </div>
        <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
      </div>

      <div class="rounded-2xl bg-white shadow p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / å¾©å…ƒ</h2>
        <div class="flex flex-wrap gap-3">
          <button id="exportBtn" class="px-4 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ›¸ãå‡ºã—ï¼ˆ.tspï¼‰</button>
          <label class="px-4 py-2 rounded-2xl bg-slate-800 text-white hover:bg-slate-900 cursor-pointer">
            ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿
            <input id="importInput" type="file" accept="application/json,.tsp" class="hidden" />
          </label>
          <button id="clearBtn" class="px-4 py-2 rounded-2xl bg-rose-600 text-white hover:bg-rose-700">ã“ã®ç«¯æœ«ã‹ã‚‰å‰Šé™¤</button>
        </div>
        <p class="mt-2 text-xs text-slate-500">â€» æ©Ÿç¨®å¤‰æ›´æ™‚ã¯ã€Œæ›¸ãå‡ºã—ã€â†’æ–°ç«¯æœ«ã§æœ¬ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€Œèª­ã¿è¾¼ã¿ã€ã€‚</p>
      </div>
    </section>

    <footer class="mt-6 text-center text-xs text-slate-500">
      Â© TSP / ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¢ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãªã—ãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã€‚
    </footer>
  </div>

  <script>
    // ---------- å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
    const $ = (sel) => document.querySelector(sel);
    const statusDot = $('#statusDot');
    const statusText = $('#statusText');
    let saveTimer;
    function showSaving() {
      statusDot.className = 'inline-block w-2.5 h-2.5 rounded-full bg-amber-500';
      statusText.textContent = 'ä¿å­˜ä¸­â€¦';
    }
    function showSaved() {
      statusDot.className = 'inline-block w-2.5 h-2.5 rounded-full bg-emerald-500';
      statusText.textContent = 'ä¿å­˜æ¸ˆã¿';
    }
    function debounceSave(fn, delay=400) {
      return (...args) => {
        showSaving();
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => fn(...args).then(showSaved), delay);
      };
    }

    // ---------- ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºã‚¿ã‚° ----------
    (function() {
      const ua = navigator.userAgent;
      let name = 'ãƒ–ãƒ©ã‚¦ã‚¶';
      if (ua.includes('Safari') && !ua.includes('Chrome')) name = 'Safari';
      else if (ua.includes('Chrome')) name = 'Chrome';
      else if (ua.includes('Firefox')) name = 'Firefox';
      else if (ua.includes('Edg')) name = 'Edge';
      $('#browserTag').textContent = name;
    })();

    // ---------- PWA: ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨SWã‚’å‹•çš„ç”Ÿæˆ ----------
    (function setupPWA(){
      const manifest = {
        name: 'TSP QRã‚¢ãƒ«ãƒãƒ ',
        short_name: 'TSP Album',
        start_url: '.',
        display: 'standalone',
        background_color: '#0ea5e9',
        theme_color: '#0ea5e9',
        icons: []
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = url;
      document.head.appendChild(link);

      if ('serviceWorker' in navigator) {
        const swCode = `
          const CACHE = 'tsp-cache-v1';
          self.addEventListener('install', e=>{
            e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
            self.skipWaiting();
          });
          self.addEventListener('activate', e=>{ self.clients.claim(); });
          self.addEventListener('fetch', e=>{
            const req = e.request;
            e.respondWith(
              caches.match(req).then(cached=> cached || fetch(req).then(res=>{
                const copy = res.clone();
                caches.open(CACHE).then(c=> c.put(req, copy));
                return res;
              }).catch(()=> cached))
            );
          });
        `;
        const swBlob = new Blob([swCode], {type:'text/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).then(()=>{
          $('#pwaTag').classList.remove('hidden');
        }).catch(()=>{});
      }

      if (navigator.storage && navigator.storage.persist) {
        navigator.storage.persist(); // æ¶ˆã•ã‚Œã«ãã
      }
    })();

    // ---------- IndexedDB ãƒ©ãƒƒãƒ‘ãƒ¼ ----------
    const DB_NAME = 'tsp_album_db';
    const DB_VERSION = 1;
    let db;
    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta', {keyPath:'key'});
          if (!db.objectStoreNames.contains('album')) db.createObjectStore('album', {keyPath:'key'});
          if (!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs', {keyPath:'id'});
        };
        req.onsuccess = ()=>{ db = req.result; resolve(db); };
        req.onerror = ()=> reject(req.error);
      });
    }
    function tx(store, mode='readonly'){ return db.transaction(store, mode).objectStore(store); }

    async function get(store, key){ return await new Promise((res, rej)=>{ const r=tx(store).get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
    async function put(store, val){ return await new Promise((res, rej)=>{ const r=tx(store,'readwrite').put(val); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
    async function del(store, key){ return await new Promise((res, rej)=>{ const r=tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
    async function allBlobs(){ return await new Promise((res, rej)=>{ const r=tx('blobs').getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }); }

    // ---------- ãƒ‡ãƒã‚¤ã‚¹IDç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰ ----------
    function getDeviceId(){
      let id = localStorage.getItem('tsp_device_id');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('tsp_device_id', id); }
      return id;
    }

    // ---------- ãƒ¢ãƒ‡ãƒ« ----------
    const ALBUM_KEY = 'unified'; // çµ±ä¸€QRã«å¯¾å¿œ
    async function loadAlbum(){
      const row = await get('album', ALBUM_KEY);
      return row ? row : { key: ALBUM_KEY, title:'', notes:'', items:[], updatedAt: Date.now(), deviceId: getDeviceId() };
    }
    async function saveAlbumPartial(patch){
      const cur = await loadAlbum();
      const next = {...cur, ...patch, updatedAt: Date.now()};
      await put('album', next);
    }

    // ---------- ç”»åƒ/å‹•ç”»ã®å–ã‚Šæ‰±ã„ï¼ˆè»½é‡åŒ–ï¼‰ ----------
    async function processFile(file, compress){
      if (!compress) return file; // ãã®ã¾ã¾
      if (file.type.startsWith('image/')) {
        const img = await createImageBitmap(file);
        const max = 2000; // é•·è¾ºä¸Šé™
        const scale = Math.min(1, max / Math.max(img.width, img.height));
        const canvas = new OffscreenCanvas(Math.round(img.width*scale), Math.round(img.height*scale));
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const blob = await canvas.convertToBlob({ type:'image/jpeg', quality:0.85 });
        return new File([blob], file.name.replace(/\.[^.]+$/,'.jpg'), {type:'image/jpeg'});
      } else if (file.type.startsWith('video/')) {
        // ç°¡æ˜“ï¼šå‹•ç”»ã¯åœ§ç¸®ã›ãšãã®ã¾ã¾ä¿å­˜ï¼ˆUIã§æ³¨æ„ï¼‰ã€‚æœ¬æ ¼åœ§ç¸®ã¯ffmpeg.wasmã‚’æ¡ç”¨ã—ã¦ã‚‚OK
        return file;
      } else {
        return file;
      }
    }

    async function addFiles(files){
      const compress = $('#compressToggle').checked;
      for (const f of files){
        const proc = await processFile(f, compress);
        const id = crypto.randomUUID();
        const blob = proc;
        await put('blobs', { id, type: blob.type, data: blob, name: proc.name, size: proc.size });
        const album = await loadAlbum();
        album.items.push({ id, kind: blob.type.startsWith('image/') ? 'image' : (blob.type.startsWith('video/') ? 'video' : 'file'), name: proc.name, size: proc.size });
        album.updatedAt = Date.now();
        await put('album', album);
      }
      await renderGallery();
      showSaved();
    }

    // ---------- è¡¨ç¤º ----------
    async function renderGallery(){
      const wrap = $('#gallery');
      wrap.innerHTML='';
      const album = await loadAlbum();
      for (const it of album.items){
        const blobRow = await get('blobs', it.id);
        if (!blobRow) continue;
        const url = URL.createObjectURL(blobRow.data);
        const card = document.createElement('div');
        card.className = 'fade-in rounded-xl border border-slate-200 overflow-hidden bg-white shadow';
        if (it.kind==='image') {
          card.innerHTML = `<img src="${url}" alt="" class="w-full h-36 object-cover">`;
        } else if (it.kind==='video') {
          card.innerHTML = `<video src="${url}" class="w-full h-36 object-cover" controls></video>`;
        } else {
          card.innerHTML = `<div class='p-3 text-sm'>${it.name}</div>`;
        }
        const bar = document.createElement('div');
        bar.className = 'flex items-center justify-between p-2 text-xs text-slate-600';
        bar.innerHTML = `<span class='truncate px-1'>${it.name}</span>`;
        const delBtn = document.createElement('button');
        delBtn.className = 'px-2 py-1 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100';
        delBtn.textContent = 'å‰Šé™¤';
        delBtn.onclick = async ()=>{
          // albumã‹ã‚‰é™¤å» & blobå‰Šé™¤
          const album = await loadAlbum();
          album.items = album.items.filter(x=> x.id !== it.id);
          album.updatedAt = Date.now();
          await put('album', album);
          await del('blobs', it.id);
          await renderGallery();
          showSaved();
        };
        bar.appendChild(delBtn);
        card.appendChild(bar);
        wrap.appendChild(card);
      }
    }

    // ---------- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(.tsp) æ›¸å‡º/èª­è¾¼ ----------
    async function exportTSP(){
      const album = await loadAlbum();
      const blobs = await allBlobs();
      const files = [];
      for (const b of blobs){
        const array = await b.data.arrayBuffer();
        files.push({ id: b.id, type: b.type, name: b.name, data: Array.from(new Uint8Array(array)) });
      }
      const payload = { version:1, exportedAt: Date.now(), album, files };
      const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'tsp-backup.tsp';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function importTSP(file){
      const text = await file.text();
      const payload = JSON.parse(text);
      if (!payload || !payload.album || !payload.files) throw new Error('ä¸æ­£ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—');
      // æ—¢å­˜ã‚’ã‚¯ãƒªã‚¢
      await del('album', ALBUM_KEY);
      // blobs ã‚‚ã‚¯ãƒªã‚¢ï¼ˆç°¡æ˜“å®Ÿè£…ï¼šDBã‚’å†ä½œæˆã—ã¦ã‚‚è‰¯ã„ï¼‰
      const all = await allBlobs();
      for (const b of all){ await del('blobs', b.id); }
      // å¾©å…ƒ
      await put('album', payload.album);
      for (const f of payload.files){
        const u8 = new Uint8Array(f.data);
        const blob = new Blob([u8], {type: f.type});
        await put('blobs', { id: f.id, type: f.type, data: blob, name: f.name, size: u8.byteLength });
      }
      await renderGallery();
      $('#title').value = payload.album.title || '';
      $('#notes').value = payload.album.notes || '';
      showSaved();
    }

    // ---------- èµ·å‹•å‡¦ç† ----------
    (async function init(){
      await openDB();
      const album = await loadAlbum();
      $('#title').value = album.title || '';
      $('#notes').value = album.notes || '';
      await renderGallery();

      // å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©
      $('#title').addEventListener('input', debounceSave(async ()=>{
        await saveAlbumPartial({ title: $('#title').value });
      }));
      $('#notes').addEventListener('input', debounceSave(async ()=>{
        await saveAlbumPartial({ notes: $('#notes').value });
      }));

      $('#fileInput').addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files||[]);
        if (!files.length) return;
        showSaving();
        await addFiles(files);
        e.target.value = '';
      });

      $('#exportBtn').addEventListener('click', exportTSP);
      $('#importInput').addEventListener('change', async (e)=>{
        const f = e.target.files?.[0]; if (!f) return;
        showSaving();
        try { await importTSP(f); } catch(err){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        e.target.value = '';
      });

      $('#clearBtn').addEventListener('click', async ()=>{
        if (!confirm('ã“ã®ç«¯æœ«ã‹ã‚‰ã‚¢ãƒ«ãƒãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ãŠæ¸ˆã¿ã§ã™ã‹ï¼Ÿï¼‰')) return;
        await del('album', ALBUM_KEY);
        const all = await allBlobs();
        for (const b of all){ await del('blobs', b.id); }
        $('#title').value = '';
        $('#notes').value = '';
        await renderGallery();
        showSaved();
      });
    })();
  </script>
</body>
</html>